<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Report Issue - Lab Booking</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <div class="topbar">
        <h1>Report an Issue</h1>
        <nav class="nav">
          <a href="index.php">Home</a>
          <a href="mybookings.php">My Bookings</a>
          <a href="login.php">Login</a>
        </nav>
        <div id="userInfo" class="user-info"></div>
      </div>
    </header>
    <main>
      <section class="card" style="max-width:720px;margin:20px auto;">
        <div id="notLogged" class="muted">You must be logged in to submit a report. <a href="login.php">Login</a></div>
        <form id="reportForm" style="display:none;">
          <div><strong>Booking:</strong> <span id="bookingKey"></span></div>
          <label for="message">Describe the problem</label>
          <textarea id="message" rows="6" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--surface-border)"></textarea>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
            <button type="submit" class="btn primary">Submit Report</button>
            <a href="mybookings.php" class="btn ghost">Cancel</a>
          </div>
        </form>
      </section>
    </main>
    <script src="app.js"></script>
    <script>
      function getQuery(name){
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      async function submitReport(e){
        e.preventDefault();
        const user = bookingApp.currentUser;
        if(!user) return alert('Login required');
        const bookingKey = getQuery('booking');
        const message = document.getElementById('message').value.trim();
        if(!message) return alert('Please describe the problem');

        // Try backend endpoint first
        try{
          const res = await fetch('/api/reports',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bookingKey,message,username:user})});
          if(res.ok){ alert('Report submitted to server.'); window.location.href='mybookings.php'; return; }
        }catch(e){ /* ignore, fallback to local storage */ }

        // Fallback: save locally
        const reports = bookingApp.loadReports();
        reports.push({ ts: Date.now(), user, bookingKey, message });
        bookingApp.saveReports(reports);
        alert('Report saved locally. The administrator can review it.');
        window.location.href = 'mybookings.php';
      }

      document.addEventListener('DOMContentLoaded', ()=>{
        const bookingKey = getQuery('booking');
        const user = bookingApp.currentUser;
        if(!user){ document.getElementById('notLogged').style.display='block'; return; }
        document.getElementById('notLogged').style.display='none';
        document.getElementById('reportForm').style.display='block';
        document.getElementById('bookingKey').textContent = bookingKey ? escapeHtml(bookingKey) : '(none)';
        document.getElementById('reportForm').addEventListener('submit', submitReport);
        updateUserUI && updateUserUI();
      });
    </script>
  </body>
</html>
