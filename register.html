<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Register - Lab Booking</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <div class="topbar">
        <h1>Register</h1>
        <nav class="nav">
          <a href="index.html">Home</a>
          <a href="mybookings.html">My Bookings</a>
          <a href="login.html">Login</a>
        </nav>
        <div id="userInfo" class="user-info"></div>
      </div>
    </header>
    <main>
      <section class="card" style="max-width:420px;margin:20px auto;">
        <form id="registerForm">
          <label for="userName">Name</label>
          <input id="userName" name="userName" required placeholder="Your name" />
          <label for="email" style="margin-top:8px">Email</label>
          <input id="email" name="email" type="email" required placeholder="your@email.com" />
          <label for="password">Password</label>
          <input id="password" name="password" type= "password" required placeholder="Your password" />
          <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
            <button type="submit">Register</button>
            <a href="login.html" class="muted">Cancel</a>
          </div>
        </form>
      </section>
    </main>
    <script src="app.js"></script>
    <script>
      async function tryApiRegister(user_name, email, password){
        try{
          const res = await fetch('http://localhost:3000/api/users',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_name, email, password})});
          if(!res.ok) return {error:true, message:await res.text()};
          const data = await res.json();
          return data;
        }catch(e){ console.error(e); return {error:true, network:true}; }
      }

      document.getElementById('registerForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const user_name = document.getElementById('userName').value.trim();
        const email = document.getElementById('email').value.trim();
        if(!user_name || !email) return alert('Enter name and email');
        const result = await tryApiRegister(user_name, email);
        if(result && !result.error && result.user_id){
          // Get user data and store
          const userData = {user_id: result.user_id, user_name, email};
          bookingApp.setCurrentUser(userData);
          return;
        }
        if(result && result.network){
          alert('Backend server is not running. Please start the server.');
          return;
        }
        alert('Registration failed: ' + (result.message || 'unknown'));
      });
      
      document.addEventListener('DOMContentLoaded', () => {
        bookingApp.updateUserUI();
      });
    </script>
  </body>
</html>
